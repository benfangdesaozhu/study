<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <!-- <script>
        var PENDING = 0
        var FULFILLED = 1
        var REJECTED = 2
        function MyPromise (fn) {
            var _this = this
            // 默认状态是PENDING
            _this.state = PENDING
            // 存储状态的值 默认是null
            _this.fulfillValue = null
            
            _this.rejectValue = null
            _this.fulfillCallbackList = []
            _this.rejectCallbackList = []

            // 状态转换为fulfill
            function fulfill (result) {
                _this.state = FULFILLED
                _this.fulfillValue = result
                _this.fulfillCallbackList.forEach(element => {
                    element()
                })
            }

            // 状态转换为reject
            function reject (error) {
                _this.state = REJECTED
                _this.rejectValue = error
                _this.rejectCallbackList.forEach(element => {
                    element()
                })
            }
            try {
                fn(fulfill, reject)
            }catch(err) {
                reject(err)
            }
        }
        MyPromise.prototype.then = function (a, b) {
            if(this.state === FULFILLED) {
                a(this.fulfillValue)
            }
            if (this.status === REJECTED) {
                b(this.rejectValue)
            }
            if(this.state === PENDING) {
                this.fulfillCallbackList.push(() => {
                    a(this.fulfillValue)
                })
                this.rejectCallbackList.push(() => {
                    b(this.rejectValue)
                })
            }
        }
        new MyPromise(function(res, rej){
            res(1)
        }).then(res => {
            console.log(res)
        })
        new MyPromise(function(res, rej){
            setTimeout(()=>{
                res(1)
            }, 2000)
        }).then(res => {
            console.log(res)
        })
    </script> -->
    <script>
        var PENDING = 0
        var FULFILLED = 1
        var REJECTED = 2

        function myPromise(fn) {
            var _this = this
            // 默认状态是PENDING
            _this.state = PENDING
            // 存储状态的值 默认是null
            _this.flufillValue = null
            _this.rejectValue = null

            _this.onFlufilledCallbacks = []  // Promise resolve回调函数
            _this.onRejectedCallbacks = []  // Promise reject回调函数

            _this.resolve = function (value) {
                // 如果参数是个promise(也就是新的myPromise的实例)
                if(value instanceof myPromise) {
                    return value.then(_this.resolve, _this.reject)
                }
                setTimeout(() => {
                    if(_this.state === PENDING) {
                        _this.state === FULFILLED
                        _this.flufillValue = value
                        _this.onFlufilledCallbacks.forEach((ele) => {
                            ele()
                        })
                    }
                })
            }

            _this.reject = function (value) {
                setTimeout(() => {
                    if(_this.state === PENDING) {
                        _this.state === REJECTED
                        _this.rejectValue = value
                        _this.onRejectedCallbacks.forEach((ele) => {
                            ele()
                        })
                    }
                })
            }
            try {
                fn(_this.resolve, _this.reject)
            }catch(err) {
                _this.reject(err)
            }
        }
        myPromise.prototype.then = function (a, b) {
            var _this = this
            a = typeof a === 'function' ? a : (value) => {value}
            b = typeof b === 'function' ? b : (error) => { throw error}
            if(this.state === FULFILLED) {
                return new myPromise(function(resolve, reject) {
                    setTimeout(() => {
                        var x = a(_this.flufillValue)
                        console.log(a)
                        if(_this.flufillValue instanceof myPromise) {
                            return _this.flufillValue.then(_this.resolve, _this.reject)
                        }
                        resolve(x)
                    })
                })
            }
            if (this.state === REJECTED) {
                return new myPromise(function(resolve, reject) {
                    setTimeout(() => {
                        reject(b(_this.rejectValue))
                    })
                })
            }
            if(this.state === PENDING) {
                return new myPromise(function(resolve, reject) {
                    _this.onFlufilledCallbacks.push(() => {
                       var x = a(_this.flufillValue)
                        console.log(x)
                        if(_this.flufillValue instanceof myPromise) {
                          x.then(resolve, reject)
                        }
                        resolve(x)
                    })
                    _this.onRejectedCallbacks.push((resolve, reject) => {
                        reject(b(_this.rejectValue))
                    })
                })
            }
        }
        new myPromise(function(resolve, reject) {
          resolve(1)
        }).then('2').then(3).then(res => console.log(res))
    </script>
</body>
</html>